<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: head (titulo='Método Pago')"></head>

<body>
<div th:if="${usuario != null}">
    <div th:replace="fragments :: navbar(userName=${usuario} ? ${usuario.getNombre()} : '',
                         userId=${usuario} ? ${usuario.getId()} : '',
                         admin=${usuario} ? ${usuario.isAdministrador()} : '')"></div>
</div>

<div th:if="${usuario == null}">
    <div th:replace="fragments :: navbar_noLogueado"></div>
</div>

<main style="flex: 1;">
    <div class="container" style="margin-top: 50px;">
        <div class="row justify-content-center mt-5">
            <div class="col-md-6">
                <h2 style="color: #171a1d; text-align: center; margin-bottom: 30px;">Método de pago</h2>
                <form method="get" th:action="@{/alquilar/{vehiculoId}/detallesAlquiler (vehiculoId=${vehiculo.id})}" onsubmit="return validateForm()">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="tarjeta" style="color: #333; font-family: 'Quicksand', sans-serif;">Tarjeta de debito/crédito</label>
                            <input id="tarjeta" class="form-control" name="tarjeta" type="number" required/>
                            <div class="invalid-feedback">
                                La tarjeta es obligatoria.
                            </div>
                        </div>
                    </div>

                    <div th:if="${mismoDia}" class="form-row">
                        <div class="form-group col-md-6">
                            <label style="color: #333; font-family: 'Quicksand', sans-serif;">Has escogido un alquiler de 1 día o 1/2 día</label>
                        </div>
                    </div>

                    <div th:unless="${mismoDia}" class="form-row">
                        <div class="form-group col-md-6">
                            <label style="color: #333; font-family: 'Quicksand', sans-serif;">Has escogido un alquiler de <span th:text="${diasDeAlquiler}"></span> días</label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="precioPorDia" style="color: #333; font-family: 'Quicksand', sans-serif;">Precio por Día (€)</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <input type="checkbox" aria-label="Checkbox for following text input" name="selectedPrice" id="checkDia" onchange="onlyOneCheckbox(this.id)">
                                    </div>
                                </div>
                                <input id="precioPorDia" class="form-control" type="text" th:value="${vehiculo.precioPorDia} + ' €'" readonly/>
                            </div>
                        </div>
                        <div th:if="${mismoDia}" class="form-group col-md-6">
                            <label for="precioPorMedioDia" style="color: #333; font-family: 'Quicksand', sans-serif;">Precio por Medio Día (€)</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <input type="checkbox" aria-label="Checkbox for following text input" name="selectedPrice" id="checkMedioDia" onchange="onlyOneCheckbox(this.id)">
                                    </div>
                                </div>
                                <input id="precioPorMedioDia" class="form-control" type="text" th:value="${vehiculo.precioPorMedioDia} + ' €'" readonly/>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="precioPorCombustible" style="color: #333; font-family: 'Quicksand', sans-serif;">Precio Combustible (€/L)</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <div class="input-group-text">
                                        <input type="checkbox" aria-label="Checkbox for following text input" name="selectedPrice" id="checkCombustible" onchange="onlyOneCheckbox(this.id)">
                                    </div>
                                </div>
                                <input id="precioPorCombustible" class="form-control" type="text" th:value="${vehiculo.precioCombustible} + ' €'" readonly/>
                            </div>
                        </div>
                    </div>

                    <div class="form-group col-md-6" id="litrosCombustibleContainer" style="display:none;">
                        <label for="litrosCombustible" style="color: #333; font-family: 'Quicksand', sans-serif;">Litros de Combustible</label>
                        <input id="litrosCombustible" class="form-control" name="litrosCombustible" type="number" min="0" required disabled/>
                    </div>

                    <input type="hidden" id="fechaInicial" name="fechaInicial" th:value="${#dates.format(fechaInicial, 'yyyy-MM-dd')}"/>
                    <input type="hidden" id="fechaFinal" name="fechaFinal" th:value="${#dates.format(fechaFinal, 'yyyy-MM-dd')}"/>
                    <input type="hidden" name="opcionSeleccionada" id="opcionSeleccionada" value="" />

                    <div th:if="${error != null}" class="alert alert-danger" style="max-width: 500px; margin-left: auto; margin-right: auto; display: block;">
                        <p th:text="${error}"></p>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" style="background-color: #171a1d; border-color: #171a1d; color: #fff;">Detalles del pago</button>
                    <p class="text-center mt-3">
                        <a href="/home" class="btn btn-link" style="color: #171a1d;">Volver</a>
                    </p>
                </form>
            </div>
        </div>
    </div>
</main>

<div th:replace="fragments :: footer"></div>
<div th:replace="fragments::javascript"/>

<script>
    function onlyOneCheckbox(checkboxId) {
        var checkboxes = document.getElementsByName('selectedPrice');
        var selectedOption = document.getElementById('opcionSeleccionada');
        var litrosInput = document.getElementById('litrosCombustible');
        var litrosContainer = document.getElementById('litrosCombustibleContainer');

        checkboxes.forEach((item) => {
            if (item.id !== checkboxId) item.checked = false;
            if (item.checked) {
                selectedOption.value = item.id === 'checkDia' ? 'dia' :
                    item.id === 'checkMedioDia' ? 'medioDia' :
                        'combustible';
                if (item.id === 'checkCombustible') {
                    litrosContainer.style.display = '';
                    litrosInput.disabled = false;
                } else {
                    litrosContainer.style.display = 'none';
                    litrosInput.disabled = true;
                    litrosInput.value = ''; // Clear value when not selected
                }
            }
        });
    }

    window.onload = function() {
        var checkboxes = document.getElementsByName('selectedPrice');
        checkboxes.forEach((checkbox) => {
            checkbox.checked = false;
        });
    }

    function validateForm() {
        var tarjeta = document.getElementById('tarjeta').value;
        var checkboxes = document.querySelectorAll('input[name="selectedPrice"]:checked');
        var litrosInput = document.getElementById('litrosCombustible');

        if (!tarjeta) {
            alert('Por favor, ingresa el número de tarjeta.');
            return false;
        }
        if (checkboxes.length === 0) {
            alert('Por favor, selecciona una opción de pago.');
            return false;
        }
        if (checkboxes[0].id === 'checkCombustible' && !litrosInput.value) {
            alert('Por favor, introduce la cantidad de litros de combustible.');
            return false;
        }
        return true;
    }
</script>

</body>
</html>